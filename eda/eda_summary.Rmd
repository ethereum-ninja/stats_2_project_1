---
title: "Exploratory Data Analysis"
author: "Kevin Thompson, Sean Kennedy, Sachin Chavan"
date: "September 29, 2019"
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(ggcorrplot)
library(visdat)
library(corrplot)
library(ggthemes)
library(sqldf)
library(rjson)
library(purrr)
library(gridExtra)
library(scales) # provides additional formatting options for ggplot objects
library(knitr)

```

## 1.1: Load data
```{r color="black"}
load("../analysis/data/.RData")
#load("../analysis/data/RData.dms") 
QBCrossSectional$Week <- as.factor(QBCrossSectional$Week)
attach(QBCrossSectional)
```

## 1.2: Structures QBCrossSectional and QBPanels

### 1.2.1 QB (Quarterback)

```{r}
summary(QBCrossSectional)
```

### 1.2.2 QB (Panel Data)

```{r}
str(QBPanels)
```

## 1.3: Missing Data 

### 1.3.1 Quarterbacks (Old Data QBdata dataset)

```{r}
vis_dat(QBCrossSectional[1:30,])
vis_dat(QBCrossSectional[31:60, ])
vis_dat(QBCrossSectional[61:89, ])
```

### 1.3.2 QBCrossSectional dataset (New dataset)
```{r}
vis_dat(QBCrossSectional)
```

###  1.3.3 QBPanels dataset (New dataset)
```{r}
print(QBPanels)

for (panel in 1:length(QBPanels)) {
   missing_plot <- vis_dat(as.data.frame(QBPanels[panel]))
   #print(missing_plot) Uncomment if you want to see plots
}
```

## 1.4: Corrrelogram 
### 1.4.1 Corrrelogram Style1 QBData (Old dataset)

```{r}
#QBdata_num <- QBCrossSectional[-c(1:3,5:16,29:36,39:52,55:56,74:89)]
#corr <- round(cor(QBdata_num), 1)

#ggcorrplot(corr, hc.order = TRUE, 
#           type = "full", 
#           lab = TRUE, 
#           lab_size = 1.5, 
#           method="square", 
#           colors = c("tomato2", "white", "springgreen3"), 
#           title="Correlogram of Quarterbacks", tl.cex = 7,pch=2,pch.col =3,show.diag = T,
#           ggtheme=theme_classic)

```

### 1.4.2 Corrrelogram Style2 QBData (Old dataset)

```{r}
#corrplot(corr, method="circle",tl.cex = 0.55,tl.col = "#1C1C1C")
```

### 1.4.3 Corrrelogram of Crosssectional data (New dataset)

```{r}
QBX_ds <- QBCrossSectional[-c(1:6,21)]
corr <- round(cor(QBX_ds), 1)
ggcorrplot(corr, hc.order = TRUE, 
           type = "full", 
           lab = TRUE, 
           lab_size = 1.5, 
           method="square", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Quarterbacks", tl.cex = 7,pch=2,pch.col =3,show.diag = T,
           ggtheme=theme_classic)
```

## 1.5: Distributions
### 1.5.1 Density plot for Fantasypoints is approxmiately Normal (Old QBData)

```{r}
library(e1071)
par(mfrow=c(1, 2))  # divide graph area in 2 columns
target <- QBCrossSectional$FantasyPoints
plot(density(target), main="QBdata: FantasyPoints", ylab="Frequency", sub=paste("Skewness:", round(e1071::skewness(target), 2)))
polygon(density(target), col="red",asp=1.2 )

```

### 1.5.2 Density plot for Fantasypoints is approxmiately Normal (New QBCrossSectional)

```{r}
par(mfrow=c(1, 2))  # divide graph area in 2 columns
target <- QBCrossSectional$FantasyPoints
plot(density(target), main="CrossSectional Dataset: FantasyPoints", ylab="Frequency", sub=paste("Skewness:", round(e1071::skewness(target), 2)))
polygon(density(target), col="red")

```

### 1.5.3 Boxplots - Target and Individual Predictor Bevavior for per Team

I think we should do these by week - not team - we want to look at variance of the time series across obervations
```{r}

QBCrossSectional %>% ggplot(aes(y=FantasyPoints,x=Week,fill=Week,group=Week))+
                     geom_boxplot(show.legend = FALSE)+
                     xlab("Week")+ylab("FantasyPoints")+
                     labs(title="Fantasyfootball", 
                     subtitle="Weekly fantasypoints", 
                     aption="Source: Fantasyfootball")+theme_economist()

for (i in 7:19) {

ggplotp <- QBCrossSectional %>% ggplot(aes_string(y=names(QBCrossSectional[i]),x=Week,fill=Week,group=Week))+
                     geom_boxplot(show.legend = FALSE)+
                     xlab("Week")+ylab(names(QBCrossSectional[i]))+
                     labs(title="Fantasyfootball", 
                     subtitle="Weekly fantasypoints", 
                     aption="Source: Fantasyfootball")+theme_economist()  
  print(ggplotp)
}



```


## Check for skewed predictors

### 1.5.4 Histograms - Normality by Week

```{r}
features_to_keep = c('PassingYards', 'PassingAttempts', 'PassingTouchdowns', 'PassingCompletions', 'PassingYardsPerAttempt')
for(f in features_to_keep){
  hist = QBCrossSectional %>% ggplot(aes_string(x=f))+
                              geom_histogram(bins=30,aes(fill=Week),show.legend = FALSE)+
                              facet_wrap(~Week,ncol=8)+theme_economist()+theme(axis.text.x = element_text(angle = 45, hjust = 1))
                              
  print(hist)
}

```


## 1.6: Relationships
### 1.6.1 Relationship between FanatasyPoints with all predictors and taking Opponent into consideration

Not sure that combining these is useful

```{r}
attach(QBCrossSectional)
QBCrossSectional %>% ggplot(aes(y=FantasyPoints,x=PassingCompletions+PassingAttempts+
                                                  PassingCompletionPercentage+
                                                  PassingYards+PassingYardsPerAttempt+
                                                  PassingTouchdowns+PassingInterceptions+
                                                  PassingRating+RushingAttempts+RushingYards+
                                                  RushingYardsPerAttempt+RushingTouchdowns+FumblesLost,
                                                  color=Opponent))+ 
                     xlab("Relationship of predictors with each Opponent")+
                     geom_point()+
                     geom_smooth(method="lm",se=F)+
                     theme(axis.text.x = element_text(angle=65, vjust=0.6))+facet_wrap(~Opponent)

``` 

### 1.6.2 Relationship between FanatasyPoints with all predictors and taking Home turf into consideration

Same here.....
```{r}
attach(QBCrossSectional)
QBCrossSectional %>% ggplot(aes(y=FantasyPoints,x=PassingCompletions+PassingAttempts+
                                                  PassingCompletionPercentage+
                                                  PassingYards+PassingYardsPerAttempt+
                                                  PassingTouchdowns+PassingInterceptions+
                                                  PassingRating+RushingAttempts+RushingYards+
                                                  RushingYardsPerAttempt+RushingTouchdowns+FumblesLost,
                                                  color=TeamIsHome))+
                     geom_point()+
                     geom_smooth(method="lm",se=F)+
                     theme(axis.text.x = element_text(angle=65, vjust=0.6))+facet_wrap(~TeamIsHome)

``` 


### 1.6.3 Relationship between FanatasyPoints with all predictors per team

and here......

```{r}
attach(QBCrossSectional)
QBCrossSectional %>% ggplot(aes(y=FantasyPoints,x=PassingCompletions+PassingAttempts+
                                                  PassingCompletionPercentage+
                                                  PassingYards+PassingYardsPerAttempt+
                                                  PassingTouchdowns+PassingInterceptions+
                                                  PassingRating+RushingAttempts+
                                                  RushingYards+RushingYardsPerAttempt+
                                                  RushingTouchdowns+FumblesLost,color=Team)) +
                     geom_point()+
                     geom_smooth(method="lm",se=F)+
                     theme(axis.text.x = element_text(angle=65, vjust=0.6))+facet_wrap(~Team)

``` 

### 1.6.4 Relationship between FantasyPoints and Individual predictors

    This makes sense - but we are actually trying to capture what the NEXT value for fantasy points is likely to be - these are all going to be highly correlated to the current 
    week since the fantasy score is a linear combination of the predictors for any given week. We need to shift the data (and z-score it?) before running these charts.
    

```{r}
for (i in 7:19) {
  linear_plot <- QBCrossSectional %>% 
                 ggplot(aes_string(y="FantasyPoints",x=names(QBCrossSectional[i]))) + 
                 geom_point()+geom_smooth(method="lm",se=F)+
                 theme(axis.text.x = element_text(angle=65, vjust=0.6))+
                 theme_economist()
    print(linear_plot) 
  }

```


Drop rushing yards per attempt

## 1.7 Defensive stats

### 1.7.1 Player Defensive Stats


```{r}

defensive_positions = getFootballData("https://fantasydata.com/FantasyStatsNFL/FantasyStats_Read?sort=FantasyPoints-desc&pageSize=4000&group=&filter=&filters.position=8&filters.team=&filters.teamkey=&filters.season=2017&filters.seasontype=1&filters.scope=2&filters.subscope=1&filters.redzonescope=&filters.scoringsystem=&filters.leaguetype=&filters.searchtext=&filters.week=&filters.startweek=1&filters.endweek=17&filters.minimumsnaps=&filters.teamaspect=&filters.stattype=&filters.exportType=&filters.desktop=&filter#s.dfsoperator=&filters.dfsslateid=&filters.dfsslategameid=&filters.dfsrosterslot=&filters.page=&filters.showfavs=&filters.posgroup=&filters.oddsstate=&filters.aggregatesc#ope=1&filters.rangescope=&filters.range=1")

defensive_positions$StatSummary = c(NULL)




```

###  1.7.2 Team Defensive Stats

```{r}

team_defense = getFootballData("https://fantasydata.com/FantasyStatsNFL/FantasyStats_Read?sort=FantasyPoints-desc&pageSize=4000&group=&filter=&filters.position=7&filters.team=&filters.teamkey=&filters.season=2017&filters.seasontype=1&filters.scope=2&filters.subscope=1&filters.redzonescope=&filters.scoringsystem=&filters.leaguetype=&filters.searchtext=&filters.week=&filters.startweek=1&filters.endweek=17&filters.minimumsnaps=&filters.teamaspect=&filters.stattype=&filters.exportType=&filters.desktop=&filters.dfsoperator=&filters.dfsslateid=&filters.dfsslategameid=&filters.dfsrosterslot=&filters.page=&filters.showfavs=&filters.posgroup=&filters.oddsstate=&filters.aggregatescope=1&filters.rangescope=&filters.range=1")
team_defense$StatSummary = c(NULL)


```

##  Defensive Players and team defense by week

```{r}
defensive_players_by_week =  sqldf("SELECT 
                                      Week, 
                                      FantasyPosition,
                                      Count(*)
                                    FROM defensive_positions
                                    GROUP BY Week, FantasyPosition")

team_defense_by_week =  sqldf("SELECT 
                                      Week, 
                                      FantasyPosition,
                                      Count(*)
                                    FROM team_defense
                                    GROUP BY Week, FantasyPosition")

# this looks good some teams are on bye in certain weeks
```

### Do some averages for Defense before stitching on to QB data

```{r}
defensive_columns = c('Team', 'Week', 'TacklesForLoss', 'Sacks', 'QuarterbackHits', 'Interceptions', 'FumblesRecovered', 'Safeties', 'DefensiveTouchdowns', 'SoloTackles', 'AssistedTackles', 'SackYards', 'PassesDefended', 'FumblesForced', 'FantasyPoints', 'PointsAllowedByDefenseSpecialTeams')


team_defense = team_defense %>% select(defensive_columns) %>% rename('DefensiveFantasyPoints'='FantasyPoints') %>% group_by(Week) %>%
               mutate(WeeklyRank = dense_rank(DefensiveFantasyPoints))
#               mutate(PlayerName = paste(FirstName," ",LastName))
attach(team_defense)
  
team_defense$Week = as.factor(team_defense$Week)  
  
sqldf("SELECT Week, Team, WeeklyRank FROM team_defense  WHERE Week IN(1, 2) ORDER BY Team, Week")
```

## Add defensive matchups

```{r}

QBCrossSectionalDefensiveOverlay = QBCrossSectional %>% left_join(team_defense, by = c('Week'='Week', 'Opponent'='Team')) 

```

## 1.7.3 Add some lag data for QB

### CumulativeVariables (these should definitley be combined into a weekly ranking)

```{r}

#Should we just train on second half of 2017?
QBCrossSectionalDefensiveOverlayCumulativePassYards = QBCrossSectionalDefensiveOverlay %>% group_by(PlayerID) %>% arrange(Week) %>%           mutate(CumulativeAveragePassingYards=cummean(PassingYards)
        , CumulativeAveragePassingTouchdowns=cummean(PassingTouchdowns)
        , CumulativeAverageCompletions = cummean(PassingCompletions) # not sure that completions matter much - most leagues don't reward them
        , CumulativeMaxPassingTouchdowns = cummax(PassingTouchdowns) 
        , CumulativeMaxPassingYards = cummax(PassingYards)
        , CumulativeMaxPassingAttempts = cummax(PassingAttempts)
        , CumulativeMaxPassingRating = cummax(PassingRating)
        , CumulativeMaxCompletions = cummax(PassingCompletions)
        , CumulativeMaxPassYardsPerAttempt = cummax(PassingYardsPerAttempt)
        , CumulativeMinPassingTouchdowns = cummin(PassingTouchdowns) 
        , CumulativeMinPassingYards = cummin(PassingYards)   #Let's get mins to capture downside risk
        , CumulativeMinPassingAttempts = cummin(PassingAttempts)
        , CumulativeMinPassingRating = cummin(PassingRating)
        , CumulativeMinCompletions = cummin(PassingCompletions)
        , CumulativeMinPassYardsPerAttempt = cummin(PassingYardsPerAttempt)
        , LastWeekQuarterBackRating = lag(PassingRating)
        , LastWeekQuarterPassingYards = lag(PassingYards)
        , LastWeekQuarterPassingTouchdowns = lag(PassingTouchdowns)
        , NextWeekFantasyPoints = lead(FantasyPoints) #Target Variable
        )

QBCrossSectionalDefensiveOverlayCumulativePassYards %>% filter(PlayerID == 6739) %>% write.csv('alex_smith.csv') #Alex Smith did indeed pass for 4042 yards on the season:)
final_ds <- QBCrossSectionalDefensiveOverlayCumulativePassYards
```

## 1.7.4 Individuals Line plots for cumulative averages by week

```{r}

for(p in 37:51){
  #print(paste("violin plots for ",names(players_ds[p])))
   for (player in seq(1,length(unique(final_ds$PlayerID)),by=30)){
       a_size <- player + 29
       players_ds <- final_ds %>% filter(PlayerID %in% unique(final_ds$PlayerID)[player:a_size])
    
       line_plot  <-  players_ds %>% 
                   ggplot(aes_string(x="as.numeric(Week)",y=names(players_ds[p])))+
                   ggtitle(names(players_ds[p]))+
                   geom_line(show.legend = FALSE)+
                              xlab("PlayerID")+
                              ylab(names(players_ds[p]))+  
                              labs(title="Fantasyfootball", 
                              subtitle=names(players_ds[p]), 
                              aption="Source: Fantasyfootball")+
                 theme_economist(base_size=8)+theme(axis.text.y = element_text(size=5))+
                 theme(axis.text.x = element_text(angle=65, vjust=0.6))+facet_wrap(~PlayerID)
      suppressWarnings(print(line_plot))
   }
}

```

## 1.7.5 Individuals Violin plots for cumulative averages

```{r}
for(p in 37:51){
  #print(paste("violin plots for ",names(players_ds[p])))
   for (player in seq(1,length(unique(final_ds$PlayerID)),by=20)){
       a_size <- player + 19
       players_ds <- final_ds %>% filter(PlayerID %in% unique(final_ds$PlayerID)[player:a_size])
    
      v_plot  <-  players_ds %>% 
                  ggplot(aes_string(x="as.factor(PlayerID)",y=names(players_ds[p]),fill="as.factor(PlayerID)"))+
                  ggtitle(names(players_ds[p]))+
                  geom_violin(show.legend = FALSE)+
                              xlab("PlayerID")+
                              ylab(names(players_ds[p]))+  
                              labs(title="Fantasyfootball", 
                              subtitle=names(players_ds[p]), 
                              aption="Source: Fantasyfootball")+
                 theme_economist(base_size=8)+theme(axis.text.y = element_text(size=5))+
                 theme(axis.text.x = element_text(angle=65, vjust=0.6))
      print(v_plot)
   }
}

```

## 1.7.6 Correlogram for Cumulative Averages

```{r}

final_cor_ds <- final_ds %>% select(PlayerID,FantasyPoints,names(final_ds[37:51]))
corr <- round(cor(final_cor_ds[-1]), 1)
ggcorrplot(corr, hc.order = TRUE, 
           type = "full", 
           lab = TRUE, 
           lab_size = 1.5, 
           method="square", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of Cumulative Averages", tl.cex = 7,pch=2,pch.col =3,show.diag = T,
           ggtheme=theme_classic)

```


## 1.7.7 Individuals Bar plots for cumulative averages

```{r}

for(p in 37:51){
   for (player in seq(1,length(unique(final_ds$PlayerID)),by=30)){
       a_size <- player + 29
       players_ds <- final_ds %>% filter(PlayerID %in% unique(final_ds$PlayerID)[player:a_size])
    
       bar_plot  <-   players_ds %>% 
                      ggplot(aes_string(x="as.factor(PlayerID)",y=names(players_ds[p]),fill="as.factor(PlayerID)"))+
                      ggtitle(names(players_ds[p]))+
                      geom_bar(stat="identity", width=.5, show.legend = FALSE)+
                      xlab("PlayerID")+
                      ylab(names(players_ds[p]))+  
                      labs(title="Fantasyfootball", 
                           subtitle=names(players_ds[p]), 
                           aption="Source: Fantasyfootball")+
                      theme_economist(base_size=8)+theme(axis.text.y = element_text(size=5))+
                      theme(axis.text.x = element_text(angle=65, vjust=0.6))
           print(bar_plot)
       }
}

```

## 1.7.8 Linear plots for cumulative averages

```{r}

for (i in 37:51) {
  linear_cum_plot <- final_ds %>% 
                     ggplot(aes_string(y="FantasyPoints",x=names(final_ds[i]),color="Week"))  + 
                     geom_point()+
                     geom_smooth(method="lm",se=F)+
                     xlab(names(final_ds[i]))+
                     ylab("FantasyPoints")+  
                     labs(title="Fantasyfootball", 
                             subtitle=names(players_ds[p]), 
                             aption="Source: Fantasyfootball")+
                     theme_wsj()+
                     theme(plot.title    = element_text(size = rel(0.5)),
                           plot.subtitle = element_text(size = rel(0.5)),
                           axis.text.x   = element_text(angle=65, vjust=0.6,size=1),
                           axis.title    = element_text(size = rel(0.5)),
                           legend.position  = "right",
                           legend.direction ="vertical",
                           legend.title = element_text(size = rel(0.5))
                          )
    print(linear_cum_plot) 
  }

```
